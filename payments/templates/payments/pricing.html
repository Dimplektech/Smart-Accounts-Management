{% extends 'accounts/base.html' %} {% load static %} {% block title %}Pricing
Plans - Smart Account Management{% endblock %} {% block extra_head %}
<script src="https://js.stripe.com/v3/"></script>
<style>
  .pricing-card {
    transition: transform 0.3s ease;
    border: 2px solid transparent;
  }
  .pricing-card:hover {
    transform: translateY(-5px);
    border-color: #007bff;
  }
  .price-highlight {
    font-size: 2.5rem;
    font-weight: bold;
    color: #007bff;
  }
  .feature-list {
    list-style: none;
    padding: 0;
  }
  .feature-list li {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
  }
  .feature-list li:before {
    content: "âœ“";
    color: #28a745;
    font-weight: bold;
    margin-right: 10px;
  }
</style>
{% endblock %} {% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12 text-center mb-5">
      <h1 class="display-4">Choose Your Plan</h1>
      <p class="lead">Unlock advanced features for better expense management</p>
    </div>
  </div>

  <div class="row justify-content-center">
    {% for plan in plans %}
    <div class="col-md-4 mb-4">
      <div class="card pricing-card h-100 shadow">
        <div class="card-header text-center bg-primary text-white">
          <h3>{{ plan.name }}</h3>
        </div>
        <div class="card-body text-center">
          <div class="price-highlight">
            ${{ plan.price }}
            <small class="text-muted">/month</small>
          </div>

          <ul class="feature-list mt-4">
            {% for feature in plan.features %}
            <li>{{ feature }}</li>
            {% endfor %}
          </ul>
        </div>
        <div class="card-footer text-center">
          <button
            class="btn btn-primary btn-lg subscribe-btn"
            data-plan="{{ plan.name|lower }}"
            data-price="{{ plan.price }}"
            data-stripe-price-id="{{ plan.stripe_price_id }}"
          >
            Choose {{ plan.name }}
          </button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="row mt-5">
    <div class="col-12 text-center">
      <h3>Need Individual Features?</h3>
      <p>Purchase premium features individually</p>
      <a
        href="{% url 'payments:premium_features' %}"
        class="btn btn-outline-primary"
      >
        View Premium Features
      </a>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div
  class="modal fade"
  id="paymentModal"
  tabindex="-1"
  aria-labelledby="paymentModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="paymentModalLabel">Complete Payment</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="payment-form">
          <div id="card-element">
            <!-- Stripe Elements will create form elements here -->
          </div>
          <div id="card-errors" role="alert" class="text-danger mt-2"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" id="submit-payment">
          Pay Now
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize Stripe
    const stripe = Stripe("{{ stripe_publishable_key }}");
    const elements = stripe.elements();

    // Create card element
    const cardElement = elements.create("card");
    cardElement.mount("#card-element");

    let currentPaymentIntent = null;
    let selectedPlan = null;

    // Handle subscription button clicks
    document.querySelectorAll(".subscribe-btn").forEach((button) => {
      button.addEventListener("click", function () {
        selectedPlan = {
          name: this.dataset.plan,
          price: parseFloat(this.dataset.price),
          stripePriceId: this.dataset.stripePriceId,
        };

        // Create payment intent
        createPaymentIntent(selectedPlan.price, "subscription");
      });
    });

    function createPaymentIntent(amount, paymentType) {
      fetch('{% url "payments:create_payment_intent" %}', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          amount: amount,
          payment_type: paymentType,
          description: `${selectedPlan.name} Plan Subscription`,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.error) {
            alert("Error: " + data.error);
          } else {
            currentPaymentIntent = data.client_secret;
            const modal = new bootstrap.Modal(
              document.getElementById("paymentModal")
            );
            modal.show();
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("An error occurred. Please try again.");
        });
    }

    // Handle payment submission
    document
      .getElementById("submit-payment")
      .addEventListener("click", function () {
        if (!currentPaymentIntent) return;

        stripe
          .confirmCardPayment(currentPaymentIntent, {
            payment_method: {
              card: cardElement,
            },
          })
          .then(function (result) {
            if (result.error) {
              document.getElementById("card-errors").textContent =
                result.error.message;
            } else {
              // Redirect to success page
              window.location.href =
                '{% url "payments:success" %}?payment_intent=' +
                result.paymentIntent.id;
            }
          });
      });

    // Helper function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>
{% endblock %}
