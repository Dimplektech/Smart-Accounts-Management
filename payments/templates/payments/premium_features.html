{% extends 'accounts/base.html' %} {% load static %} {% block title %}Premium
Features - Smart Account Management{% endblock %} {% block extra_head %}
<script src="https://js.stripe.com/v3/"></script>
<style>
  .feature-card {
    transition: transform 0.3s ease;
    border: 2px solid transparent;
  }
  .feature-card:hover {
    transform: translateY(-3px);
    border-color: #007bff;
  }
  .feature-owned {
    background-color: #d4edda;
    border-color: #28a745;
  }
  .price-tag {
    font-size: 1.5rem;
    font-weight: bold;
    color: #007bff;
  }
</style>
{% endblock %} {% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12 text-center mb-5">
      <h1 class="display-4">Premium Features</h1>
      <p class="lead">
        Enhance your experience with individual premium features
      </p>
    </div>
  </div>

  <div class="row">
    {% for feature in features %}
    <div class="col-md-6 mb-4">
      <div
        class="card feature-card h-100 shadow {% if feature.feature_type in user_features %}feature-owned{% endif %}"
      >
        <div class="card-body">
          <h5 class="card-title">
            {{ feature.name }} {% if feature.feature_type in user_features %}
            <span class="badge badge-success ml-2">Owned</span>
            {% endif %}
          </h5>
          <p class="card-text">{{ feature.description }}</p>
          <div class="price-tag">
            ${{ feature.price }}
            <small class="text-muted">one-time</small>
          </div>
        </div>
        <div class="card-footer">
          {% if feature.feature_type in user_features %}
          <button class="btn btn-success btn-block" disabled>
            <i class="fas fa-check"></i> Already Purchased
          </button>
          {% else %}
          <button
            class="btn btn-primary btn-block purchase-btn"
            data-feature="{{ feature.feature_type }}"
            data-name="{{ feature.name }}"
            data-price="{{ feature.price }}"
          >
            Purchase Feature
          </button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="row mt-5">
    <div class="col-12 text-center">
      <h3>Want All Features?</h3>
      <p>Consider subscribing to one of our plans for better value</p>
      <a href="{% url 'payments:pricing' %}" class="btn btn-outline-primary">
        View Subscription Plans
      </a>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="paymentModalLabel">Purchase Feature</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="feature-info" class="mb-3"></div>
        <form id="payment-form">
          <div id="card-element">
            <!-- Stripe Elements will create form elements here -->
          </div>
          <div id="card-errors" role="alert" class="text-danger mt-2"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" id="submit-payment">
          Purchase Now
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize Stripe
    const stripe = Stripe("{{ stripe_publishable_key }}");
    const elements = stripe.elements();

    // Create card element
    const cardElement = elements.create("card");
    cardElement.mount("#card-element");

    let currentPaymentIntent = null;
    let selectedFeature = null;

    // Handle purchase button clicks
    document.querySelectorAll(".purchase-btn").forEach((button) => {
      button.addEventListener("click", function () {
        selectedFeature = {
          type: this.dataset.feature,
          name: this.dataset.name,
          price: parseFloat(this.dataset.price),
        };

        // Update modal content
        document.getElementById("feature-info").innerHTML = `
                <h6>${selectedFeature.name}</h6>
                <p class="text-muted">Price: $${selectedFeature.price}</p>
            `;

        // Create payment intent
        createPaymentIntent(selectedFeature.price, "premium_feature");
      });
    });

    function createPaymentIntent(amount, paymentType) {
      fetch('{% url "payments:create_payment_intent" %}', {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
          amount: amount,
          payment_type: paymentType,
          description: `Premium Feature: ${selectedFeature.name}`,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.error) {
            alert("Error: " + data.error);
          } else {
            currentPaymentIntent = data.client_secret;
            const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
            modal.show();
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("An error occurred. Please try again.");
        });
    }

    // Handle payment submission
    document
      .getElementById("submit-payment")
      .addEventListener("click", function () {
        if (!currentPaymentIntent) return;

        stripe
          .confirmCardPayment(currentPaymentIntent, {
            payment_method: {
              card: cardElement,
            },
          })
          .then(function (result) {
            if (result.error) {
              document.getElementById("card-errors").textContent =
                result.error.message;
            } else {
              // Redirect to success page with feature type
              window.location.href =
                '{% url "payments:success" %}?payment_intent=' +
                result.paymentIntent.id +
                "&feature_type=" +
                selectedFeature.type;
            }
          });
      });

    // Helper function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>
{% endblock %}
